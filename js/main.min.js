$(function () {
    //magnific-popup
    $('.popup_about_link').magnificPopup({
        type: 'inline',
    })
    $(document).on('click', '.popup_about-dismiss', function (e) {
        e.preventDefault()
        $.magnificPopup.close()
    })

    //pagetoscroll
    $(window).on('load', function () {
        $('a,a[href=\'#top\'],a[rel=\'m_PageScroll2id\'],a.PageScroll2id').mPageScroll2id({
            highlightSelector: 'a',
        })
    })

})


$(function () {
    // откуда берем данные сформы
    $('form').submit(function (e) {
        //отменяем стандартное действие при отправке формы
        e.preventDefault();
        var m_id = $(this).attr('class');
        //берем из формы метод передачи данных
        var m_method = $(this).attr('method');
        //получаем адрес скрипта на сервере, куда нужно отправить форму
        var m_action = $(this).attr('action');
        //получаем данные, введенные пользователем в формате input1=value1&input2=value2...,
        //то есть в стандартном формате передачи данных формы
        // var m_data = $(this).serialize();
        var m_data = new FormData($(this)[0]);
        m_data.append('class',m_id);
        $.ajax({
            type: m_method,
            url: m_action,
            data: m_data,
            processData: false,
            contentType: false,
            dataType: 'json',
            encode: true,

        })
            .done(function (data) {
                console.log(data)
                // где показываем результат
                if (!data.success) {
                    $('.form__error-contact').css('display','block');
                    $('.form__error').css('display','block');
                    if (data.errors.phone) {
                        $('.form__error').html(data.errors.phone);
                    } else if (data.errors.services) {
                        $('.form__error').html(data.errors.services);
                    } else if (data.errors.messages) {
                        $('.form__error').html(data.errors.messages);
                    }else if (data.errors.email) {
                        $('.form__error-contact').html(data.errors.email);
                    }else if (data.errors.text) {
                        $('.form__error-contact').html(data.errors.text);
                    }
                } else {
                    if(data.order) {
                        $('.form__result').css({'display':'block','margin-top':'15px'});
                        $('.form__result').html(data.message);
                        $('.form__error').hide();
                        setTimeout(function () {
                            $('form')[0].reset();
                            $('.form__result').html('');
                            window.location = location.href;
                        }, 5000);
                    }else {
                        $('.form__result-contact').css({'display':'block','margin-top':'15px'});
                        $('.form__result-contact').html(data.message);
                        $('.form__error-contact').hide();
                        setTimeout(function () {
                            $('form')[1].reset();
                            $('.form__result-contact').html('');
                            window.location = location.href;
                        }, 5000);
                    }


                }
            });
    });
});


// Кнопка вверх
$(window).scroll(function () {
    if ($(window).scrollTop() > 1) {
        buttonUp.show(500);
    } else {
        buttonUp.hide(500);
    }
});


buttonUp = $('#btnUp');
buttonUp.on('click', function (event) {
    event.preventDefault();
    $('html, body').animate({
        scrollTop: $('body').offset().top
    }, 800);
});
document.addEventListener("DOMContentLoaded", function () {

    var input = document.querySelector('input:not(.order__form-input)');
    var preview = document.querySelector('.order__form-file');
    input.addEventListener('change', updateImageDisplay);
    input.style.opacity = 0;
    input.style.display = 'none';


    function updateImageDisplay() {
        // while(preview.firstChild) {
        //     preview.removeChild(preview.firstChild);
        // }

        var curFiles = input.files;
        if (curFiles.length > 0) {
            // var para = document.createElement('p');
            // para.textContent = 'No files currently selected for upload';
            // preview.appendChild(para);

            // var list = document.createElement('ol');
            // preview.appendChild(list);
            for (var i = 0; i < curFiles.length; i++) {
                // var listItem = document.createElement('li');
                var para = document.createElement('p');
                para.classList.add('order__file');
                if (validFileType(curFiles[i])) {
                    para.textContent = curFiles[i].name + '.';
                    // var image = document.createElement('img');
                    // image.src = window.URL.createObjectURL(curFiles[i]);

                    // listItem.appendChild(image);
                    preview.appendChild(para);

                } else {
                    para.textContent = 'File name ' + curFiles[i].name + ': Not a valid file type. Update your selection.';
                    preview.appendChild(para);
                }

                preview.appendChild(para);
            }
        }
    }

    var fileTypes = [
        'image/jpeg',
        'image/pjpeg',
        'image/png'
    ]

    function validFileType(file) {
        for (var i = 0; i < fileTypes.length; i++) {
            if (file.type === fileTypes[i]) {
                return true;
            }
        }

        return false;
    }

    function returnFileSize(number) {
        if (number < 1024) {
            return number + 'bytes';
        } else if (number > 1024 && number < 1048576) {
            return (number / 1024).toFixed(1) + 'KB';
        } else if (number > 1048576) {
            return (number / 1048576).toFixed(1) + 'MB';
        }
    }
});
